<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 7161cbbe-4109-4755-a8dc-12db9cbf77bd (2025-12-16 15:02Z) -->

# Phase 2 testing guide database queries (2025-12-16 15:02Z)

_**User (2025-12-16 12:12Z)**_

can you add some helpful db query commands to @artifacts/wip/issues/phase-2-chromadb/Phase-2-TESTING_GUIDE.md  so i can check things like "Draft ID is valid (can be queried from database)" and "ChromaDB collection should be created" etc

---

_**Agent (model default, mode Agent)**_



---


Reviewing the database structure to add helpful query commands to the testing guide.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /home/amite/code/python/personal-triage-agent/utils/artifacts_db.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /home/amite/code/python/personal-triage-agent/utils/chromadb_manager.py</summary>

</details>
</tool-use>

---



---


Adding helpful database query commands throughout the testing guide.


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /home/amite/code/python/personal-triage-agent/artifacts/wip/issues/phase-2-chromadb/Phase-2-TESTING_GUIDE.md</summary>

**Chunk 1**
Lines added: 47, lines removed: 1

```diff
@@ -172,9 +172,55 @@
     - [ ] Draft ID is valid (can be queried from database)
     - [ ] Thread ID is linked to the draft
- 
+    
+    **Query Commands:**
+    &#96;&#96;&#96;bash
+    # Get draft by ID (replace 1 with actual draft ID from output)
+    uv run python -c "
+    from utils.artifacts_db import ArtifactsDB
+    db = ArtifactsDB()
+    draft = db.get_draft(1)
+    if draft:
+        print(f'✓ Draft ID 1 found: {draft[\"subject\"]}')
+        print(f'  Thread ID: {draft[\"thread_id\"]}')
+        print(f'  Created: {draft[\"created_at\"]}')
+    else:
+        print('✗ Draft ID 1 not found')
+    "
+    
+    # List all drafts
+    uv run python -c "
+    from utils.artifacts_db import ArtifactsDB
+    db = ArtifactsDB()
+    drafts = db.get_drafts_by_thread('unknown')
+    print(f'✓ Found {len(drafts)} draft(s)')
+    for d in drafts:
+        print(f'  - ID {d[\"id\"]}: {d[\"subject\"]} (thread: {d[\"thread_id\"]})')
+    "
+    &#96;&#96;&#96;
+ 
  5. **Verify Indexing Happened**
     - [ ] No errors in console about indexing
     - [ ] (Optional) Check logs for "indexing" messages
     - [ ] ChromaDB collection should be created
+    
+    **Query Commands:**
+    &#96;&#96;&#96;bash
+    # Check ChromaDB collection exists and has documents
+    uv run python -c "
+    from utils.chromadb_manager import ChromaDBManager
+    manager = ChromaDBManager()
+    collection = manager.get_collection()
+    if collection:
+        count = manager.get_draft_count()
+        print(f'✓ ChromaDB collection exists: email_drafts')
+        print(f'  Documents indexed: {count}')
+    else:
+        print('✗ ChromaDB collection not found')
+    "
+    
+    # Check ChromaDB directory exists
+    ls -la data/chromadb/
+    # Should show database files (chroma.sqlite3, etc.)
+    &#96;&#96;&#96;
  
  6. **Verify Search Executes**
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /home/amite/code/python/personal-triage-agent/artifacts/wip/issues/phase-2-chromadb/Phase-2-TESTING_GUIDE.md</summary>

**Chunk 1**
Lines added: 35, lines removed: 1

```diff
@@ -277,10 +277,44 @@
     # Check draft exists in artifacts database
     uv run python -c "from utils.artifacts_db import ArtifactsDB; db = ArtifactsDB(); drafts = db.get_drafts_by_thread('unknown'); print(f'✓ Found {len(drafts)} draft(s) in database')"
+    
+    # Get specific draft with all metadata
+    uv run python -c "
+    from utils.artifacts_db import ArtifactsDB
+    db = ArtifactsDB()
+    drafts = db.get_drafts_by_thread('unknown')
+    if drafts:
+        d = drafts[0]
+        print(f'✓ Draft ID {d[\"id\"]}:')
+        print(f'  Subject: {d[\"subject\"]}')
+        print(f'  Created: {d[\"created_at\"]}')
+        print(f'  Status: {d[\"status\"]}')
+        print(f'  Body preview: {d[\"body\"][:100]}...')
+    "
     &#96;&#96;&#96;
  
  4. **Check ChromaDB Directly (Optional)**
     &#96;&#96;&#96;bash
+    # Check ChromaDB directory and files
     ls -la data/chromadb/
-    # Should see database files created
+    # Should see database files created (chroma.sqlite3, etc.)
+    
+    # Check ChromaDB collection and document count
+    uv run python -c "
+    from utils.chromadb_manager import ChromaDBManager
+    manager = ChromaDBManager()
+    collection = manager.get_collection()
+    if collection:
+        count = manager.get_draft_count()
+        print(f'✓ ChromaDB collection: email_drafts')
+        print(f'  Total documents: {count}')
+        
+        # Get sample document IDs
+        if count &gt; 0:
+            results = collection.get(limit=1)
+            if results['ids']:
+                print(f'  Sample document ID: {results[\"ids\"][0]}')
+    else:
+        print('✗ ChromaDB collection not initialized')
+    "
     &#96;&#96;&#96;
  
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /home/amite/code/python/personal-triage-agent/artifacts/wip/issues/phase-2-chromadb/Phase-2-TESTING_GUIDE.md</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -519,5 +519,5 @@
  2. **Verify Draft in Database**
     &#96;&#96;&#96;bash
-    # Query database directly
+    # Query database directly - list all drafts
     uv run python -c "
     from utils.artifacts_db import ArtifactsDB
```

**Chunk 2**
Lines added: 30, lines removed: undefined

```diff
@@ -528,4 +528,34 @@
         print(f'  - ID {draft[\"id\"]}: {draft[\"subject\"]} (created: {draft[\"created_at\"]})')
     "
+    
+    # Get specific draft by ID (replace 1 with actual draft ID)
+    uv run python -c "
+    from utils.artifacts_db import ArtifactsDB
+    db = ArtifactsDB()
+    draft = db.get_draft(1)
+    if draft:
+        print(f'✓ Draft ID 1 details:')
+        print(f'  Subject: {draft[\"subject\"]}')
+        print(f'  Thread ID: {draft[\"thread_id\"]}')
+        print(f'  Created: {draft[\"created_at\"]}')
+        print(f'  Status: {draft[\"status\"]}')
+        print(f'  Body length: {len(draft[\"body\"])} chars')
+    else:
+        print('✗ Draft ID 1 not found')
+    "
+    
+    # Query using SQL directly for more control
+    uv run python -c "
+    import sqlite3
+    conn = sqlite3.connect('data/artifacts.db')
+    conn.row_factory = sqlite3.Row
+    cursor = conn.cursor()
+    cursor.execute('SELECT * FROM drafts ORDER BY created_at DESC LIMIT 5')
+    drafts = cursor.fetchall()
+    print(f'✓ Latest {len(drafts)} draft(s):')
+    for d in drafts:
+        print(f'  - ID {d[\"id\"]}: {d[\"subject\"]} (thread: {d[\"thread_id\"]}, created: {d[\"created_at\"]})')
+    conn.close()
+    "
     &#96;&#96;&#96;
     - [ ] Draft record exists in database
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /home/amite/code/python/personal-triage-agent/artifacts/wip/issues/phase-2-chromadb/Phase-2-TESTING_GUIDE.md</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -574,4 +574,5 @@
  4. **Verify Reminder in Database**
     &#96;&#96;&#96;bash
+    # List all reminders
     uv run python -c "
     from utils.artifacts_db import ArtifactsDB
```

**Chunk 2**
Lines added: 17, lines removed: undefined

```diff
@@ -582,4 +583,21 @@
         print(f'  - ID {reminder[\"id\"]}: {reminder[\"content\"]} (status: {reminder[\"status\"]})')
     "
+    
+    # Get specific reminder by ID (replace 1 with actual reminder ID)
+    uv run python -c "
+    from utils.artifacts_db import ArtifactsDB
+    db = ArtifactsDB()
+    reminder = db.get_reminder(1)
+    if reminder:
+        print(f'✓ Reminder ID 1 details:')
+        print(f'  Content: {reminder[\"content\"]}')
+        print(f'  Status: {reminder[\"status\"]}')
+        print(f'  Thread ID: {reminder[\"thread_id\"]}')
+        print(f'  Created: {reminder[\"created_at\"]}')
+        if reminder.get('due_date'):
+            print(f'  Due: {reminder[\"due_date\"]}')
+    else:
+        print('✗ Reminder ID 1 not found')
+    "
     &#96;&#96;&#96;
     - [ ] Reminder record exists in database
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /home/amite/code/python/personal-triage-agent/artifacts/wip/issues/phase-2-chromadb/Phase-2-TESTING_GUIDE.md</summary>

**Chunk 1**
Lines added: 27, lines removed: 2

```diff
@@ -677,6 +677,31 @@
     # Should show database file
  
-    # Query database directly
-    uv run python -c "from utils.artifacts_db import ArtifactsDB; db = ArtifactsDB(); drafts = db.get_drafts_by_thread('unknown'); print(f'✓ Found {len(drafts)} draft(s) in database')"
+    # Query database directly - count all drafts
+    uv run python -c "
+    from utils.artifacts_db import ArtifactsDB
+    db = ArtifactsDB()
+    drafts = db.get_drafts_by_thread('unknown')
+    print(f'✓ Found {len(drafts)} draft(s) in database')
+    if drafts:
+        print('  Latest drafts:')
+        for d in drafts[:3]:
+            print(f'    - ID {d[\"id\"]}: {d[\"subject\"]} ({d[\"created_at\"]})')
+    "
+    
+    # Check database file size
+    du -sh data/artifacts.db
+    # Should show non-zero size
+    
+    # Verify specific draft from previous session still exists
+    uv run python -c "
+    from utils.artifacts_db import ArtifactsDB
+    db = ArtifactsDB()
+    # Replace 1 with the draft ID from session 1
+    draft = db.get_draft(1)
+    if draft:
+        print(f'✓ Draft from session 1 still exists: ID {draft[\"id\"]} - {draft[\"subject\"]}')
+    else:
+        print('✗ Draft from session 1 not found')
+    "
     &#96;&#96;&#96;
     - [ ] Database file exists
```

**Chunk 2**
Lines added: 26, lines removed: 1

```diff
@@ -685,13 +710,38 @@
  6. **Verify ChromaDB Files**
     &#96;&#96;&#96;bash
+    # Check ChromaDB directory exists
     ls -la data/chromadb/
-    # Should show database files
+    # Should show database files (chroma.sqlite3, etc.)
  
     # Check file sizes increased
     du -sh data/chromadb/
+    # Should show non-zero size
+    
+    # Verify ChromaDB collection persisted and has documents
+    uv run python -c "
+    from utils.chromadb_manager import ChromaDBManager
+    manager = ChromaDBManager()
+    collection = manager.get_collection()
+    if collection:
+        count = manager.get_draft_count()
+        print(f'✓ ChromaDB collection persisted: email_drafts')
+        print(f'  Total indexed documents: {count}')
+        
+        # Get sample documents to verify data
+        if count &gt; 0:
+            results = collection.get(limit=min(3, count))
+            print(f'  Sample document IDs: {results[\"ids\"]}')
+            if results.get('metadatas'):
+                print(f'  Sample metadata:')
+                for i, meta in enumerate(results['metadatas'][:2]):
+                    print(f'    - {results[\"ids\"][i]}: draft_id={meta.get(\"draft_id\")}, subject={meta.get(\"subject\", \"N/A\")[:50]}')
+    else:
+        print('✗ ChromaDB collection not found')
+    "
     &#96;&#96;&#96;
     - [ ] Directory exists
     - [ ] Contains database files
     - [ ] Files are not empty
+    - [ ] Collection contains indexed documents from previous session
  
  ### Expected Output
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /home/amite/code/python/personal-triage-agent/artifacts/wip/issues/phase-2-chromadb/Phase-2-TESTING_GUIDE.md</summary>

**Chunk 1**
Lines added: 185, lines removed: undefined

```diff
@@ -974,4 +974,189 @@
  - **Blockers:** None / ___
  - **Recommendation:** **PASS** / **FAIL** / **CONDITIONAL**
+ 
+ ---
+ 
+ ## Database Query Reference
+ 
+ ### Quick Reference Commands
+ 
+ #### Artifacts Database (SQLite) Queries
+ 
+ **List all drafts:**
+ &#96;&#96;&#96;bash
+ uv run python -c "
+ from utils.artifacts_db import ArtifactsDB
+ db = ArtifactsDB()
+ drafts = db.get_drafts_by_thread('unknown')
+ print(f'Total drafts: {len(drafts)}')
+ for d in drafts:
+     print(f'  ID {d[\"id\"]}: {d[\"subject\"]} ({d[\"created_at\"]})')
+ "
+ &#96;&#96;&#96;
+ 
+ **Get specific draft by ID:**
+ &#96;&#96;&#96;bash
+ # Replace 1 with actual draft ID
+ uv run python -c "
+ from utils.artifacts_db import ArtifactsDB
+ db = ArtifactsDB()
+ draft = db.get_draft(1)
+ if draft:
+     print(f'Draft ID {draft[\"id\"]}:')
+     print(f'  Subject: {draft[\"subject\"]}')
+     print(f'  Thread ID: {draft[\"thread_id\"]}')
+     print(f'  Created: {draft[\"created_at\"]}')
+     print(f'  Status: {draft[\"status\"]}')
+     print(f'  Body length: {len(draft[\"body\"])} chars')
+ "
+ &#96;&#96;&#96;
+ 
+ **List all reminders:**
+ &#96;&#96;&#96;bash
+ uv run python -c "
+ from utils.artifacts_db import ArtifactsDB
+ db = ArtifactsDB()
+ reminders = db.get_reminders_by_thread('unknown')
+ print(f'Total reminders: {len(reminders)}')
+ for r in reminders:
+     print(f'  ID {r[\"id\"]}: {r[\"content\"][:50]}... (status: {r[\"status\"]})')
+ "
+ &#96;&#96;&#96;
+ 
+ **Get specific reminder by ID:**
+ &#96;&#96;&#96;bash
+ # Replace 1 with actual reminder ID
+ uv run python -c "
+ from utils.artifacts_db import ArtifactsDB
+ db = ArtifactsDB()
+ reminder = db.get_reminder(1)
+ if reminder:
+     print(f'Reminder ID {reminder[\"id\"]}:')
+     print(f'  Content: {reminder[\"content\"]}')
+     print(f'  Status: {reminder[\"status\"]}')
+     print(f'  Thread ID: {reminder[\"thread_id\"]}')
+ "
+ &#96;&#96;&#96;
+ 
+ **Direct SQL queries:**
+ &#96;&#96;&#96;bash
+ # Count all drafts
+ uv run python -c "
+ import sqlite3
+ conn = sqlite3.connect('data/artifacts.db')
+ cursor = conn.cursor()
+ cursor.execute('SELECT COUNT(*) FROM drafts')
+ print(f'Total drafts: {cursor.fetchone()[0]}')
+ conn.close()
+ "
+ 
+ # Get drafts with full details
+ uv run python -c "
+ import sqlite3
+ conn = sqlite3.connect('data/artifacts.db')
+ conn.row_factory = sqlite3.Row
+ cursor = conn.cursor()
+ cursor.execute('SELECT id, subject, thread_id, created_at, status FROM drafts ORDER BY created_at DESC LIMIT 10')
+ for row in cursor.fetchall():
+     print(f'ID {row[\"id\"]}: {row[\"subject\"]} (thread: {row[\"thread_id\"]}, {row[\"created_at\"]})')
+ conn.close()
+ "
+ &#96;&#96;&#96;
+ 
+ #### ChromaDB Queries
+ 
+ **Check collection exists and get document count:**
+ &#96;&#96;&#96;bash
+ uv run python -c "
+ from utils.chromadb_manager import ChromaDBManager
+ manager = ChromaDBManager()
+ collection = manager.get_collection()
+ if collection:
+     count = manager.get_draft_count()
+     print(f'✓ Collection: email_drafts')
+     print(f'  Total documents: {count}')
+ else:
+     print('✗ Collection not found')
+ "
+ &#96;&#96;&#96;
+ 
+ **Get sample documents from ChromaDB:**
+ &#96;&#96;&#96;bash
+ uv run python -c "
+ from utils.chromadb_manager import ChromaDBManager
+ manager = ChromaDBManager()
+ collection = manager.get_collection()
+ if collection:
+     count = manager.get_draft_count()
+     if count &gt; 0:
+         results = collection.get(limit=min(5, count))
+         print(f'Sample documents ({len(results[\"ids\"])}):')
+         for i, doc_id in enumerate(results['ids']):
+             meta = results['metadatas'][i] if results.get('metadatas') else {}
+             print(f'  - {doc_id}: draft_id={meta.get(\"draft_id\")}, subject={meta.get(\"subject\", \"N/A\")[:50]}')
+     else:
+         print('No documents in collection')
+ "
+ &#96;&#96;&#96;
+ 
+ **Search ChromaDB directly (test semantic search):**
+ &#96;&#96;&#96;bash
+ uv run python -c "
+ from utils.chromadb_manager import ChromaDBManager
+ manager = ChromaDBManager()
+ results = manager.search_drafts('budget approval', n_results=3)
+ print(f'Search results: {len(results)}')
+ for r in results:
+     print(f'  - ID: {r[\"id\"]}')
+     print(f'    Distance: {r[\"distance\"]:.4f}')
+     if r.get('metadata'):
+         print(f'    Draft ID: {r[\"metadata\"].get(\"draft_id\")}')
+         print(f'    Subject: {r[\"metadata\"].get(\"subject\", \"N/A\")}')
+ "
+ &#96;&#96;&#96;
+ 
+ **Check ChromaDB file structure:**
+ &#96;&#96;&#96;bash
+ # List ChromaDB files
+ ls -la data/chromadb/
+ 
+ # Check file sizes
+ du -sh data/chromadb/*
+ 
+ # Check if collection database exists
+ ls -la data/chromadb/chroma.sqlite3
+ &#96;&#96;&#96;
+ 
+ #### Combined Verification
+ 
+ **Verify draft exists in both databases:**
+ &#96;&#96;&#96;bash
+ # Replace 1 with actual draft ID
+ uv run python -c "
+ from utils.artifacts_db import ArtifactsDB
+ from utils.chromadb_manager import ChromaDBManager
+ 
+ draft_id = 1
+ 
+ # Check artifacts database
+ db = ArtifactsDB()
+ draft = db.get_draft(draft_id)
+ if draft:
+     print(f'✓ Draft {draft_id} in artifacts DB: {draft[\"subject\"]}')
+ else:
+     print(f'✗ Draft {draft_id} NOT in artifacts DB')
+ 
+ # Check ChromaDB
+ manager = ChromaDBManager()
+ collection = manager.get_collection()
+ if collection:
+     # Search for draft by metadata
+     results = collection.get(where={'draft_id': str(draft_id)}, limit=1)
+     if results['ids']:
+         print(f'✓ Draft {draft_id} indexed in ChromaDB: {results[\"ids\"][0]}')
+     else:
+         print(f'✗ Draft {draft_id} NOT indexed in ChromaDB')
+ "
+ &#96;&#96;&#96;
  
  ---
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /home/amite/code/python/personal-triage-agent/artifacts/wip/issues/phase-2-chromadb/Phase-2-TESTING_GUIDE.md</summary>

**Chunk 1**
Lines added: 26, lines removed: 3

```diff
@@ -1195,8 +1195,31 @@
  **Solution:**
  &#96;&#96;&#96;bash
- # Check if drafts exist in database
- uv run python -c "from utils.artifacts_db import ArtifactsDB; db = ArtifactsDB(); drafts = db.get_drafts_by_thread('unknown'); print(f'Drafts in DB: {len(drafts)}'); [print(f'  - ID {d[\"id\"]}: {d[\"subject\"]}') for d in drafts]"
+ # Check if drafts exist in artifacts database
+ uv run python -c "
+ from utils.artifacts_db import ArtifactsDB
+ db = ArtifactsDB()
+ drafts = db.get_drafts_by_thread('unknown')
+ print(f'Drafts in artifacts DB: {len(drafts)}')
+ for d in drafts:
+     print(f'  - ID {d[\"id\"]}: {d[\"subject\"]}')
+ "
+ 
+ # Check ChromaDB collection and document count
+ uv run python -c "
+ from utils.chromadb_manager import ChromaDBManager
+ manager = ChromaDBManager()
+ collection = manager.get_collection()
+ if collection:
+     count = manager.get_draft_count()
+     print(f'Documents in ChromaDB: {count}')
+     if count &gt; 0:
+         # Get sample to verify indexing
+         results = collection.get(limit=1)
+         print(f'Sample document ID: {results[\"ids\"][0]}')
+ else:
+     print('ChromaDB collection not initialized')
+ "
  
- # Check ChromaDB created
+ # Check ChromaDB directory
  ls -la data/chromadb/
  
```

</details>

</tool-use>

---



---


Added database query commands throughout the testing guide. Summary:

1. **Test 2 (Draft Creation)**: Commands to verify draft records and ChromaDB indexing
2. **Test 3 (Metadata Verification)**: Expanded queries to check draft details and ChromaDB documents
3. **Test 7 (Artifacts Database)**: Enhanced queries for drafts and reminders with detailed output
4. **Test 8 (Persistence)**: Commands to verify data persists across sessions in both databases
5. **New Section: Database Query Reference**: Quick reference with common queries for:
   - Listing and getting specific drafts/reminders
   - Direct SQL queries
   - ChromaDB collection checks
   - Sample document retrieval
   - Direct semantic search testing
   - Combined verification across both databases

6. **Troubleshooting Section**: Enhanced the "Search returns no results" section with better diagnostic commands

All commands use `uv run` as required by your repository rules and include:
- Verification that draft IDs are valid and queryable
- Checks that ChromaDB collection exists and contains documents
- Commands to inspect metadata in both databases
- Tools to diagnose indexing issues

The commands are ready to copy-paste and will help verify the checks mentioned in the testing guide.

---

